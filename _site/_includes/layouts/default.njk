{%- import 'components/logo.njk' as logo -%}
{%- import 'components/heading.njk' as heading %}
{%- import 'components/tooltip.njk' as tooltip -%}

<!doctype html>
<html lang="en" class="bg-transparent antialiased" x-data="app" x-init="searchData()">

  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>{%- if title -%}{{ title +' - ' }}{%- endif -%} {{ site.meta.title }}</title>
    <meta name="description" content="{{ site.meta.description }}" />
    <meta name="author" content="{{ site.meta.author + ' - '+ site.meta.author_url }}" />
    <meta name="generator" content="{{ eleventy.generator }}" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

    <meta property="og:title" content="{% if title %}{{ title +' - '+ site.meta.title }}{% else %}{{ site.meta.title }}{% endif %}" />
    <meta property="og:description" content="{{ site.meta.description }}" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="{{ site.meta.url }}{{ page.url }}" />
    <meta property="og:image" content="{{ site.meta.url }}/pxl-hd.png" />
    <meta property="og:image:width" content="512" />
    <meta property="og:image:height" content="512" />

  </head>

  <body class="bg-gray-900 text-(gray-400 sm) !block" style="display: none;" data-instant-intensity="mousedown">
    <div class="page min-h-screen flex-(& col)">
      <header>
        <div class="container mx-auto">
          <nav aria-label="Main navigation">
            <ul class="nav-menu text-xl flex items-center">
              <li class="nav-home">
                <a href="/" class="p-4 block text-white transform motion-safe:(transition) hover:(opacity-100 -rotate-12)" aria-label="Home">
                  {{ logo.pxl(title='Home') }}
                </a>
              </li>
              {%- for item in collections.all | eleventyNavigation %}
              <li class="nav-item">
                <a href="{{ item.url }}" class="group p-4 text-white block relative motion-safe:(transition) hover:(opacity-100){% if item.url == page.url or item.url in page.url %} active{% endif %}"{%- if item.url == page.url or item.url in page.url %} aria-current="page"{%- endif -%}>
                  <iconify-icon icon="{{ item.icon }}" inline="false" class="leading-none"></iconify-icon>
                  <span class="sr-only">{{ item.key }}</span>
                  <b class="px-1 w-full h-px flex justify-center absolute inset-x-0 bottom-1"><b class="w-0 bg-brand-400 opacity-0 motion-safe:(transition-all) group-hover:(w-full opacity-100)"></b></b>
                </a>
              </li>
              {%- endfor %}
              <li class="ml-auto">
                <button type="button" class="p-4" @click="searchOpen()" aria-labelledby="search-panel-label"><iconify-icon icon="mdi:magnify-expand" inline="false" class="text-xl"></iconify-icon></button>
              </li>
            </ul>
          </nav>
          
          <section
            class="search-panel min-h-screen bg-gray-900/50 backdrop-blur-xl flex-(& col) fixed inset-0 z-50 motion-safe:(duration-300 ease-in-out transition)"
            style="display: none"
            role="dialog"
            aria-modal="true"
            @keydown.escape.prevent.stop="searchClose()"
            x-show="searching"
            x-transition:enter-start="opacity-0 scale-95 blur-lg"
            x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-95 blur-lg"
          >
            <div class="bg-black/20 absolute inset-0" aria-hidden="true"></div>
            <div
              class="py-4 w-full flex-auto relative overflow-y-auto"
              role="document"
              :tabindex="searching ? '0' : '-1'"
              x-on:click.stop
              x-trap.noreturn.noscroll.inert="searching"
            >
              <div class="container mx-auto">
                <label class="px-12 block"><span id="search-panel-label" class="sr-only">Search</span><input x-model="query" @input="search()" type="search" placeholder="Search video games: pokemon, monster hunter, final fantasy, etc." class="mb-12 py-2 px-4 border-(1 gray-500/20) w-full bg-gray-500/20 block rounded-full" /></label>
                <template x-if="results.length">
                  <section class="search-results-panel">
                    {%- call heading.x(tag='h2',sub='.',search=true) %}Results{%- endcall %}
                    <ul class="list-game pb-4 flex-(& wrap)">
                      <template x-for="item in results">
                        {% include 'components/game_alpine.njk' %}
                      </template>
                    </ul>
                  </section>
                </template>
                <template x-if="query.length > 0 && !results.length">
                  <section class="no-search-results-panel flex-(& col) items-center gap-4">
                    <iconify-icon icon="mdi:emoticon-sad" inline class="iconify text-5xl opacity-20"></iconify-icon>
                    <p class="text-gray-500 font-semibold uppercase">No results...</p>
                  </section>
                </template>
              </div>
              <button @click="searchClose()" type="button" class="absolute top-3 right-3"><iconify-icon icon="mdi:close" inline class="iconify text-2xl"></iconify-icon><span class="sr-only">Close</span></button>
            </div>
          </section>
          
          {#
            <form class="ml-auto flex items-center" action="/search/">
              <fieldset class="mr-4 ml-auto max-w-64 flex justify-end items-center relative z-30">
                <label for="site-search" class="sr-only">Search</label>
                <input type="search" id="site-search" name="q" placeholder="Search..." title="Search" autocomplete="off" class="border-(& transparent) p-2 w-8 bg-transparent text-(sm transparent) cursor-pointer outline-none appearance-none relative z-10 opacity-0 motion-safe:(transition-all) focus:(w-full bg-gray-700 text-white opacity-100)" />
                <iconify-icon icon="mdi:magnify-expand" inline="false" class="text-xl absolute right-0 z-0 opacity-40 motion-safe:(transition)"></iconify-icon>
              </fieldset>
            </form>
          #}

        </div>
      </header>
      <main class="pt-8 flex-1" data-router-wrapper>
        <section class="container mx-auto relative" data-router-view="{{ page.url | slugify }}">
          {{ content | safe }}
        </section>
      </main>
      <footer class="mt-auto pt-8 text-(xs gray-500) md:(text-sm)">
        <div class="container mx-auto px-4">
          <div class="py-8 border-(t gray-400/30) flex-(& col) items-center gap-6 md:(flex-row justify-between)">
            <div class="flex-(& none) items-center gap-4">
              <a href="/" class="flex-none transform motion-safe:(transition) hover:(-rotate-12 text-gray-200)">{{ logo.pxl(title=site.meta.name,size='32') }}</a>
              <p class="max-w-[240px]">{{ site.meta.description }}</p>
            </div>
            <ul class="text-2xl flex items-center justify-center gap-4 md:(justify-end gap-6)">
              {%- for nav in site.footer.nav %}
              <li>
                <a href="{{ nav.url }}" class="group m-auto relative motion-safe:(transition) hover:(text-gray-200)">
                  <iconify-icon icon="{{ nav.ico }}" inline="false"></iconify-icon>
                  {{ tooltip.x(tip=nav.title) }}
                </a>
              </li>
              {%- endfor %}
            </ul>
          </div>
        </div>
        <p class="pb-8 text-center font-semibold">
          Designed and engineered with
          <svg xmlns="http://www.w3.org/2000/svg" class="mx-1 text-red-500 inline-block fill-current" width="16" height="12" viewBox="0 0 16 12" role="img" aria-labelledby="footer-heart">
            <title id="footer-heart">Love</title>
            <polygon points="8 4 12 0 16 4 8 12 0 4 4 0"></polygon>
          </svg>
          by
          <a href="{{ site.meta.nick_url }}" class="text-gray-400/70 motion-safe:(transition) hover:(text-red-500)">{{ site.meta.nick }}</a>
        </p>
      </footer>
      <div class="bg-grid fixed inset-0 z-[-1]" aria-hidden="true"></div>
    </div>
    <div class="loading h-1 flex fixed inset-x-0 top-0 opacity-0 motion-safe:(transition)" aria-hidden="true"><div class="loading-progress bg-brand-400"></div><span class="sr-only">Loading...</span></div>
    <script src="/_assets/js/search.js"></script>
    <script>
      document.addEventListener('alpine:init', () => {
        Alpine.data('app', () => ({
          searching: false,
          query: '',
          results: [],
          data: [],
          index: null,
          searchData() {
            fetch('/search/data.json')
              .then((response) => response.json())
              .then((data) => {
                this.data = data;
                this.index = elasticlunr(function() {
                  this.addField('id');
                  this.addField('title');
                  this.addField('note');
                  this.setRef('id');
                  this.saveDocument(false);
                });
                data.forEach((item) => {
                  this.index.addDoc(item);
                });
              });
          },
          search() {
            if (this.index) {
              this.results = this.index
                .search(this.query, {
                  expand: true,
                  bool: 'AND',
                })
                .map((result) => this.data.find((item) => item.id === result.ref));
            }
          },
          searchOpen() {
            this.searching = true;
          },
          searchClose() {
            this.query = '';
            this.results = [];
            this.searching = false;
          },
          slugify(text) {
            return text?.toString()
              .toLowerCase()
              .normalize('NFKD')
              .replace(/[\u0300-\u036f]/g, '')
              .trim()
              .toLowerCase()
              .replace(/[^a-z0-9 -]/g, '')
              .replace(/\s+/g, '-')
              .replace(/-+/g, '-')
          },
          csv(text) {
            return text?.toString().replace(',', ', ')
          },
        }));
      });
    </script>
    <script src="/_assets/js/_app.js?v={% bust %}"></script>
  </body>

</html>