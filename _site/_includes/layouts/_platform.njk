---
layout: layouts/default.njk
---

{%- from 'components/mast.njk' import mast -%}
{%- from 'components/game.njk' import game -%}
{%- from 'components/category.njk' import category -%}

{%- set games = collections['platform_'+ title | slugify +''] -%}
{%- set systems = [] -%}{%- for s in collections.system -%}{%- if s.data.platform === title | slugify -%}{%- set systems = (systems.push(s), systems) -%}{%- endif -%}{%- endfor -%}
{%- set nav = [] -%}{%- if games | length -%}{%- set nav = (nav.push('Games'), nav) -%}{%- endif -%}{%- if systems | length -%}{%- set nav = (nav.push('Systems'), nav) -%}{%- endif -%}

{%- call mast(title=title,logo=logo) %}{%- endcall %}

<article
  x-data='{
    nav: {{ nav | dump | safe }},
    param: "view",
    active: 0,
    slugs: [],
    init() {
      this.slugs = this.nav.map(this.slug);
      this.initFromQuery();
      this.$watch("active", i => this.updateQuery(this.slugs[i] ?? String(i)));
    },
    slug(label) {
      return String(label).toLowerCase().normalize("NFKD").trim().toLowerCase().replace(/[^\w\-]+/g, "-").replace(/\s+/g, "-").replace(/-+/g, "-");
    },
    initFromQuery() {
      const url = new URL(window.location);
      const val = url.searchParams.get(this.param);
      if (!val) return;
      let idx = -1;
      if (/^\d+$/.test(val)) {
        idx = Math.max(0, Math.min(parseInt(val, 10), this.nav.length - 1));
      } else {
        idx = this.slugs.indexOf(val.toLowerCase());
      }
      if (idx >= 0) this.active = idx;
    },
    setActive(i) { this.active = i; },
    updateQuery(val) {
      const url = new URL(window.location);
      url.searchParams.set(this.param, val);
      history.replaceState({}, "", url);
    },
  }'
  x-id="['tab']"
>
  <nav class="py-8 px-4 flex items-end justify-center gap-2 lg:(w-1/2 justify-start)">
    <ul
      x-ref="tablist"
      @keydown.right.prevent.stop="$focus.wrap().next()"
      @keydown.home.prevent.stop="$focus.first()"
      @keydown.page-up.prevent.stop="$focus.first()"
      @keydown.left.prevent.stop="$focus.wrap().prev()"
      @keydown.end.prevent.stop="$focus.last()"
      @keydown.page-down.prevent.stop="$focus.last()"
      role="tablist"
      aria-label="Platform sections"
      class="tabs p-1.5 bg-black/25 shrink-0 flex items-end border-(1 dotted gray-500/50) rounded-lg before:(content-[''] bg-gray-500/20 absolute left-[anchor(left)] top-[anchor(top)] bottom-[anchor(bottom)] right-[anchor(right)] [position-anchor:--tab-active] pointer-events-none rounded transition-[left,right])"
    >
      <template x-for="(item, index) in nav" hidden>
        <li>
          <button
            @mousedown.prevent
            @click="setActive(index)"
            @focus="setActive(index)"
            :id="'tab-'+ index"
            :tabindex="index === active ? 0 : -1"
            :aria-controls="'panel-'+ index"
            :aria-selected="index === active"
            :class="index === active && 'tab-active'"
            class="tab py-0 pl-5 pr-3 border-(t transparent) h-9 font-semibold uppercase flex items-center gap-1.5 cursor-pointer transition hover:text-white [&.tab-active]:(border-gray-500/50 bg-gray-500/20 text-white rounded [anchor-name:--tab-active])"
            role="tab"
          >
            <span x-text="item"></span>
            <sup class="badge text-xs flex items-center justify-center opacity-60">
              <span x-show="index === 0">{{ games | length }}</span>
              <span x-show="index === 1">{{ systems | length }}</span>
            </sup>
          </button>
        </li>
      </template>
    </ul>
    <div class="border-(t r dotted gray-500/50) h-6 w-full max-w-[1.5rem] rounded-tr-lg lg:(max-w-none grow)" aria-hidden="true"></div>
  </nav>

  {{ content | safe }}

  {%- for panel in nav %}
    <div x-show="active === {{ loop.index0 }}" x-transition:enter.opacity.duration.500ms x-transition:leave.opacity.duration.0ms id="panel-{{ loop.index0 }}" role="tabpanel" aria-labelledby="tab-{{ loop.index0 }}">

      {#- GAMES -#}
      {%- if panel === 'Games' %}
        {{ game(games=collections['platform_'+ title | slugify],platforms=collections.platform,genres=collections.genre) }}
      {%- endif %}

      {#- SYSTEMS -#}
      {%- if panel === 'Systems' %}
        <ul class="container mx-auto flex-(& wrap)">
          {%- for item in systems %}
            {%- set sub %}{{ item.data.variation }} {{ item.data.accessories }}{%- endset %}
            {{ category(title=item.data.title,subtext=sub,bg_img='https://placehold.net/default.svg') }}
            {#- {{ category(title=item.data.title,subtext=sub,bg_img='/_assets/img/systems/'+ item.data.title | slugify +'-'+ item.data.variation | slugify +'.jpg') }} -#}
          {%- endfor %}
        </ul>
      {%- endif %}

    </div>
  {%- endfor %}

</article>
